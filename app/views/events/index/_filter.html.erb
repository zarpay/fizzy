<% filter = user_filtering.filter %>

<%= form_with url: events_path,
      method: :get, class: "flex-inline position-relative",
      data: { controller: "form", turbo_frame: "cards_container", turbo_action: "advance" } do |form| %>
  <%= tag.div class: "flex-inline position-relative quick-filter",
        data: {
          controller: "dialog multi-selection-combobox",
          action: "keydown.esc->dialog#close click@document->dialog#closeOnClickOutside",
          filter_show: user_filtering.show_collections?,
          multi_selection_combobox_no_selection_label_value: user_filtering.selected_collections_label } do %>
        <button type="button" class="btn borderless btn--plain events__filter-select" data-action="click->dialog#toggle:stop">
          <span data-multi-selection-combobox-target="label">
          </span>
        </button>

        <template data-multi-selection-combobox-target="hiddenFieldTemplate">
          <%= hidden_field_tag "collection_ids[]", nil, data: { filter_settings_target: "field" } %>
        </template>

        <%= filter_dialog "Board…" do %>
          <strong class="popup__title">Board…</strong>

          <% if user_filtering.collections.many? %>
            <%= text_field_tag nil, nil, id: nil, placeholder: "Filter…", class: "input input--transparent txt-small font-weight-normal", autofocus: true,
                  type: "search", autocorrect: "off", autocomplete: "off", data: { "1p-ignore": "true", filter_target: "input", action: "input->filter#filter" } %>
          <% end %>

          <ul class="popup__list" data-filter-target="list" role="listbox">
            <% user_filtering.collections.each do |collection| %>
              <%= tag.li class: "popup__item", data: {
                    filter_target: "item", navigable_list_target: "item", multi_selection_combobox_target: "item", multi_selection_combobox_value: collection.id, multi_selection_combobox_label: collection.name },
                    role: "checkbox", aria: { checked: filter.collections.include?(collection) } do %>
                <button type="button" class="btn popup__btn" data-action="dialog#close multi-selection-combobox#change filter-settings#change form#submit">
                  <span class="overflow-ellipsis flex-item-grow"><%= collection.name %></span>
                  <%= icon_tag "check", class: "checked flex-item-justify-end" %>
                </button>
              <% end %>
            <% end %>
          </ul>
    <% end %>
  <% end %>
<% end %>
